<?xml version="1.0"?>
<?xml-stylesheet href="modification.xsl" type="text/xsl"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

	ATTENTION: If you are trying to install this manually, you should try
	the package manager.  If it will not work for you, please take a look
	at the following for information on this format:
		http://mods.simplemachines.org/docs/manual-install.php

================================================================================

	Modification files can be used to modify files so that they do what
	your package needs them to do to work properly.

 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<!-- This information needs to be the same as that in the package-info.xml. -->
	<id>Niko:SMFProject</id>
	<version>{version}</version>

	<!-- Board directory -->
	<file name="$boarddir/index.php">
		<operation>
			<search position="before"><![CDATA[		'im' => array('PersonalMessage.php', 'MessageMain'),]]></search>
			<add><![CDATA[
		'projects' => array('Project.php', 'Projects'),]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[	elseif (empty($_REQUEST['action']))]]></search>
			<add><![CDATA[	elseif (empty($_REQUEST['action']) && (isset($_REQUEST['project']) || isset($_REQUEST['issue'])))
	{
		require_once($sourcedir . '/Project.php');
		return 'Projects';
	}]]></add>
		</operation>

		<operation>
			<search position="before"><![CDATA[
	// Check if the user should be disallowed access.
	is_not_banned();]]></search>
			<add><![CDATA[
	// Project Tools
	if (!empty($modSettings['projectEnabled']))
	{
		require_once($sourcedir . '/Subs-Project.php');
		loadProjectToolsPermissions();
	}
	else
	{
		$user_info['query_see_project'] = '0=1';
	}]]></add>
		</operation>
	</file>

	<file name="$boarddir/SSI.php">
		<operation>
			<search position="after"><![CDATA[// Load the stuff like the menu bar, etc.]]></search>
			<add><![CDATA[// Project Tools
if (!empty($modSettings['projectEnabled']))
{
	require_once($sourcedir . '/Subs-Project.php');
	loadProjectToolsPermissions();
}
else
{
	$user_info['query_see_project'] = '0=1';
}
]]></add>
		</operation>
	</file>

	<!-- Source files -->
	<file name="$sourcedir/Admin.php">
		<operation>
			<search position="after"><![CDATA[		'layout' => array(
			'title' => $txt['layout_controls'],]]></search>
			<add><![CDATA[		'project' => array(
			'title' => $txt['project_tools'],
			'permission' => array('project_admin'),
			'areas' => array(
				'manageprojects' => array(
					'label' => $txt['manage_projects'],
					'file' => 'ManageProjects.php',
					'function' => 'ManageProjects',
					'permission' => array('project_admin'),
					'subsections' => array(
						'main' => array($txt['modify_projects']),
						'new' => array($txt['new_project']),
					),
				),
				'projectpermissions' => array(
					'label' => $txt['manage_project_permissions'],
					'file' => 'ProjectPermissions.php',
					'function' => 'ManageProjectPermissions',
					'permission' => array('project_admin'),
					'subsections' => array(
						'main' => array($txt['modify_project_profiles']),
						'new' => array($txt['new_project_profile']),
					),
				),
				'manageversions' => array(
					'label' => $txt['manage_versions'],
					'file' => 'ManageVersions.php',
					'function' => 'ManageVersions',
					'permission' => array('project_admin'),
					'subsections' => array(
						'main' => array($txt['modify_versions']),
					),
				),
				'managecategories' => array(
					'label' => $txt['manage_project_category'],
					'file' => 'ManageProjects.php',
					'function' => 'ManageCategories',
					'permission' => array('project_admin'),
					'subsections' => array(
						'main' => array($txt['modify_project_category']),
					),
				),
				'projectsettings' => array(
					'label' => $txt['project_settings'],
					'file' => 'ProjectAdmin.php',
					'function' => 'ProjectsAdmin',
					'permission' => array('project_admin'),
					'subsections' => array(
						'main' => array($txt['project_settings_main']),
					),
				),
			),
		),]]></add>
		</operation>

		<operation>
			<search position="before"><![CDATA[	$language_files = array(]]></search>
			<add><![CDATA[
	'ProjectAdmin', ]]></add>
		</operation>

		<operation>
			<search position="before"><![CDATA[	$include_files = array(]]></search>
			<add><![CDATA[
	'ProjectAdmin', ]]></add>
		</operation>

		<operation>
			<search position="before"><![CDATA[		array('ModifyCacheSettings', 'area=serversettings;sa=cache'),]]></search>
			<add><![CDATA[
		array('ProjectsAdminSettings', 'area=projectsettings;sa=main'),]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Display.php">
		<operation>
			<search position="after"><![CDATA[
	// This is just a regular attachment...
	else]]></search>
			<add><![CDATA[
	elseif (isset($_REQUEST['issue']))
	{
		global $project;
		require_once($sourcedir . '/Project.php');
		loadProjectTools('smf');

		if (strpos($_REQUEST['issue'], '.') !== false)
			list ($_REQUEST['issue'], $_REQUEST['start']) = explode('.', $_REQUEST['issue'], 2);

		$request = $smcFunc['db_query']('', '
			SELECT id_project
			FROM {db_prefix}issues
			WHERE id_issue = {int:issue}',
			array(
				'issue' => (int) $_REQUEST['issue']
			)
		);

		list ($project) = $smcFunc['db_fetch_row']($request);

		if (!($context['project'] = loadProject((int) $project)))
			fatal_lang_error('project_not_found', false);

		loadProjectPermissions($project);

		// Make sure this attachment is on this issue.
		$request = $smcFunc['db_query']('', '
			SELECT a.id_folder, a.filename, a.fileext, a.id_attach, a.attachment_type, a.mime_type, a.approved
			FROM {db_prefix}attachments AS a
				INNER JOIN {db_prefix}issues AS i ON (i.id_issue = a.id_issue AND {query_see_issue})
				LEFT JOIN {db_prefix}project_versions AS ver ON (ver.id_version = i.id_version)
			WHERE a.id_attach = {int:attach}
			LIMIT 1',
			array(
				'attach' => $_REQUEST['attach'],
			)
		);
	}]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[	if ($attachment_type != 3)]]></search>
			<add><![CDATA[	if ($attachment_type != 3 && (($file_ext != 'patch' && $file_ext != 'diff') || isset($_REQUEST['dl'])))]]></add>
		</operation>

		<operation>
			<search position="before"><![CDATA[	$filename = getAttachmentFilename($real_filename, $_REQUEST['attach'], $id_folder);]]></search>
			<add><![CDATA[
	if (!isset($_REQUEST['dl']) && ($file_ext == 'patch' || $file_ext == 'diff'))
	{
		loadTemplate('PatchView', array('project'));
		$context['diff'] = DiffParser(file_get_contents($filename));
		$context['download'] = $scripturl;

		$context['page_title'] = sprintf($txt['patch_highlight'], $real_filename);

		return;
	}]]></add>
		</operation>
	</file>

	<file name="$sourcedir/ManagePermissions.php">
		<operation>
			<search position="before"><![CDATA[			'profile_remote_avatar' => array(false, 'profile', 'use_avatar'),]]></search>

			<add><![CDATA[
			'project_access' => array(false, 'project', 'project'),
			'project_profile' => array(true, 'project', 'project'),
			'project_admin' => array(false, 'project', 'administrate'),]]></add>
		</operation>
	</file>

	<file name="$sourcedir/ManageSettings.php">
		<operation>
			<search position="after"><![CDATA[
		// pm = post moderation.]]></search>
			<add><![CDATA[		// pj = project tools
		'pj' => array(
			'settings' => array(
				'projectEnabled' => 1,
			),
		),]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Subs.php">
		<operation>
			<search position="before"><![CDATA[	$context['allow_calendar'] = allowedTo('calendar_view') && !empty($modSettings['cal_enabled']);]]></search>
			<add><![CDATA[	$context['allow_project'] = !empty($modSettings['projectEnabled']) && allowedTo('project_access');]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[			'search' => array(]]></search>
			<add><![CDATA[			'projects' => array(
				'title' => $txt['projects'],
				'href' => $scripturl . '?action=projects',
				'show' => $context['allow_project'],
				'sub_buttons' => array(),
			),]]></add>
		</operation>

		<operation>
			<search position="before"><![CDATA[	if (isset($context['menu_buttons'][$context['current_action']]))
		$current_action = $context['current_action'];]]></search>
			<add><![CDATA[	elseif (empty($_REQUEST['action']) && isset($_REQUEST['project']))
		$current_action = 'projects';]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[|action=profile;u=\d+)'),]]></search>
			<add><![CDATA[|(action=projects)?(sa=viewIssue;)?(;)?issue=(\d+)(\.com(\d+))?(#com(\d+))?]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[
			array(
				'tag' => 'pre',]]></search>
			<add><![CDATA[
			array(
				'tag' => 'patch',
				'type' => 'unparsed_content',
				'before' => '<div>',
				'content' => '$1',
				'after' => '</div>',
				'validate' => create_function('&$tag, &$data, $disabled', '
					$data = strtr($data, array(\'<br />\' => "\n"));
					$diff = DiffParser($data);

					if (empty($diff))
						return;

					$data = \'\';
					foreach ($diff as $file)
					{
						$data .= \'<div class="tborder">\';
						$data .= \'<h3 class="titlebg headerpadding">\' . $file[\'name_before\'] . \'</h3>\';

						$section = false;

						foreach ($file[\'actions\'] as $action)
						{
							$style = \'\';

							if (trim($action[1]) == \'\')
								$action[1] = \'&nbsp;\';

							if (empty($action[0]))
								$style = \'\';
							elseif ($action[0] == \'@\')
							{
								if ($section)
									$data .= \'</div>\';

								$data .= \'<h4 class="catbg headerpadding">\' . $action[1] . \'</h4><div class="windowbg2 smallpadding" style="font-family: monospace; white-space: pre;">\';

								$section = true;

								continue;
							}
							elseif ($action[0] == \'a\')
								$style .= \' background-color: #DDFFDD\';
							elseif ($action[0] == \'d\')
								$style .= \' background-color: #FFDDDD\';

							if (!$section)
								$data .= \'<div class="windowbg2 smallpadding" style="font-family: monospace">\';
							$section = true;

							$data .= \'<div style="\' . $style . \'">\' . $action[1] . \'</div>\';
						}

						$data .= \'</div></div><br />\';
					}'
				),
				'block_level' => true,
			),]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[			if (!empty($modSettings['autoLinkUrls']))]]></search>
			<add><![CDATA[
			if (!empty($modSettings['linkIssues']) && !empty($modSettings['issueRegex']) && !empty($modSettings['projectEnabled']))
			{
				$no_autolink_area = false;
				if (!empty($open_tags))
				{
					foreach ($open_tags as $open_tag)
						if (in_array($open_tag['tag'], $no_autolink_tags))
							$no_autolink_area = true;
				}

				$lastAutoPos = isset($lastAutoPos) ? $lastAutoPos : 0;
				if ($pos < $lastAutoPos)
					$no_autolink_area = true;
				$lastAutoPos = $pos;

				if (!$no_autolink_area)
					$data = preg_replace_callback('/' . $modSettings['issueRegex'][0] . '/', 'issue_link_callback', $data);
			}
			]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Profile.php">
		<operation>
			<search position="after"><![CDATA[				'permissions' => array(]]></search>
			<add><![CDATA[				'project' => array(
					'label' => $txt['project_profile'],
					'file' => 'Profile-Project.php',
					'function' => 'projectProfile',
					'subsections' => array(
						'main' => array($txt['project_profile_main']),
					),
					'permission' => array(
						'own' => 'project_profile_own',
						'any' => 'project_profile_any',
					),
				),
]]></add>
		</operation>

	</file>

	<file name="$sourcedir/Subs-BoardIndex.php">
		<operation>
			<search position="after"><![CDATA[	return $boardIndexOptions['include_categories'] ? $categories : $this_category;]]></search>
			<add><![CDATA[	if (!empty($modSettings['projectEnabled']))
	{
		// TODO: Limit to projects that will be seen

		$request = $smcFunc['db_query']('', '
			SELECT
				p.id_project, p.name, p.description, p.id_category, p.cat_position, p.trackers, p.' . implode(', p.', $context['type_columns']) . ', p.id_comment_mod,
				mem.id_member, mem.real_name,
				' . ($user_info['is_guest'] ? '0 AS new_from' : '(IFNULL(log.id_comment, -1) + 1) AS new_from') . '
			FROM {db_prefix}projects AS p' . ($user_info['is_guest'] ? '' : '
				LEFT JOIN {db_prefix}log_projects AS log ON (log.id_member = {int:member}
					AND log.id_project = p.id_project)') . '
				LEFT JOIN {db_prefix}project_developer AS pdev ON (pdev.id_project = p.id_project)
				LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = pdev.id_member)
				LEFT JOIN {db_prefix}project_developer AS dev ON (dev.id_project = p.id_project
					AND dev.id_member = {int:member})
			WHERE {query_see_project}
			ORDER BY p.name',
			array(
				'member' => $user_info['id'],
			)
		);

		$context['projects'] = array();

		while ($row = $smcFunc['db_fetch_assoc']($request))
		{
			$key = $row['id_category'] . '_' . $row['cat_position'];

			if (isset($context['projects'][$key][$row['id_project']]))
			{
				if (empty($row['id_member']))
					continue;

				$context['projects'][$key][$row['id_project']]['developers'][] = '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . '">' . $row['real_name'] . '</a>';

				continue;
			}

			$context['projects'][$key][$row['id_project']] = array(
				'id' => $row['id_project'],
				'link' => '<a href="' . project_get_url(array('project' => $row['id_project'])) . '">' . $row['name'] . '</a>',
				'href' => project_get_url(array('project' => $row['id_project'])),
				'name' => $row['name'],
				'description' => $row['description'],
				'trackers' =>  explode(',', $row['trackers']),
				'new' => $row['new_from'] <= $row['id_comment_mod'] && !$user_info['is_guest'],
				'issues' => array(),
				'developers' => array(
					'<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . '">' . $row['real_name'] . '</a>'
				),
			);

			foreach ($context['projects'][$key][$row['id_project']]['trackers'] as $tracker)
			{
				$context['projects'][$key][$row['id_project']]['issues'][$$tracker] = array(
					'info' => &$context['project_tools']['issue_types'][$tracker],
					'open' => $row['open_' . $tracker],
					'closed' => $row['closed_' . $tracker],
					'total' => $row['open_' . $tracker] + $row['closed_' . $tracker],
					'link' => project_get_url(array('project' => $row['id_project'], 'sa' => 'issues', 'type' => $tracker)),
				);
			}
		}
		$smcFunc['db_free_result']($request);
	}
]]></add>
		</operation>
	</file>

	<file name="$themedir/BoardIndex.template.php">
		<operation>
			<search position="before"><![CDATA[			echo '
		<table cellspacing="1" class="bordercolor boardsframe">';]]></search>
			<add><![CDATA[
			template_boardindex_project($category['id'], 'first');]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[			echo '
		</table>';
		}
		echo '
	</div>';]]></search>
			<add><![CDATA[
			template_boardindex_project($category['id'], 'last');]]></add>
		</operation>

		<operation>
			<search position="end" />
			<add><![CDATA[
function template_boardindex_project($category, $position)
{
	global $context, $settings, $options, $txt, $modSettings;

	if (empty($context['projects'][$category . '_' . $position]))
		return;

	foreach ($context['projects'][$category . '_' . $position] as $project)
	{
		echo '
		<tr>
			<td class="windowbg icon">
				<a href="', $project['href'], '">';

			if ($project['new'])
				echo '
					<img src="', $settings['images_url'], '/on.gif" alt="', $txt['new_posts'], '" title="', $txt['new_issues'], '" />';
			else
				echo '
					<img src="', $settings['images_url'], '/off.gif" alt="', $txt['old_posts'], '" title="', $txt['old_issues'], '" />';

			echo '
				</a>
			</td>
			<td class="windowbg2 info">
				<h4><a href="', $project['href'], '">', $project['name'], '</a></h4>
				<p>', $project['description'], '</p>';

			if (!empty($project['developers']))
				echo '
				<p class="developers"><span class="smalltext">', count($project['developers']) == 1 ? $txt['developer'] : $txt['developers'], ': ', implode(', ', $project['developers']), '</span></p>';

			echo '
			</td>
			<td class="windowbg stats smalltext">';

		foreach ($project['issues'] as $type)
			echo '
				', $type['open'], ' / ', $type['total'], ' ', $type['info']['plural'], '<br />';

		echo '
			</td>
			<td class="windowbg2 lastissue">
			</td>
		</tr>';
	}
}
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Subs-Db-mysql.php">
		<operation>
			<search position="after"><![CDATA[
	if (!isset($matches[2]))]]></search>
			<add><![CDATA[
	if ($matches[1] === 'query_see_project')
		return $user_info['query_see_project'];
	elseif ($matches[1] === 'query_see_version')
		return $user_info['query_see_version'];
	elseif ($matches[1] === 'query_see_issue')
		return $user_info['query_see_issue'];
	elseif ($matches[1] === 'query_see_issue_project')
		return $user_info['query_see_issue_project'];
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Subs-Db-sqlite.php">
		<operation>
			<search position="after"><![CDATA[
	if (!isset($matches[2]))]]></search>
			<add><![CDATA[
	if ($matches[1] === 'query_see_project')
		return $user_info['query_see_project'];
	elseif ($matches[1] === 'query_see_version')
		return $user_info['query_see_version'];
	elseif ($matches[1] === 'query_see_issue')
		return $user_info['query_see_issue'];
	elseif ($matches[1] === 'query_see_issue_project')
		return $user_info['query_see_issue_project'];
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Subs-Db-postgresql.php">
		<operation>
			<search position="after"><![CDATA[
	if (!isset($matches[2]))]]></search>
			<add><![CDATA[
	if ($matches[1] === 'query_see_project')
		return $user_info['query_see_project'];
	elseif ($matches[1] === 'query_see_version')
		return $user_info['query_see_version'];
	elseif ($matches[1] === 'query_see_issue')
		return $user_info['query_see_issue'];
	elseif ($matches[1] === 'query_see_issue_project')
		return $user_info['query_see_issue_project'];
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Who.php">
		<operation>
			<search position="after"><![CDATA[		'mods' => array(]]></search>
			<add><![CDATA[
				'SMF Project Tools &copy; 2007-2008<br /><span class="smalltext">Uses <a href="http://www.famfamfam.com/lab/icons/silk/" rel="nofollow">FamFamFam Silk</a> icons licensed under Creative Commons Attribution 2.5 License</span>',]]></add>
		</operation>
	</file>

	<!-- Languages -->
	<file name="$languagedir/Modifications.english.php">
		<operation>
			<search position="end" />
			<add><![CDATA[// SMF Project tools
$txt['project_tools'] = 'Project Tools';
$txt['issue_tracker'] = 'Issue Tracker';
$txt['issues'] = 'Issues';
$txt['project'] = 'Project';
$txt['projects'] = 'Projects';
$txt['core_settings_item_pj'] = 'Project Tools';
$txt['core_settings_item_pj_desc'] = 'Enables/Disables Project Tools addon';
$txt['patch_highlight'] = 'Viewing Highlight of Patch: %s';

// Profile
$txt['project_profile'] = 'Project Tools';
$txt['project_profile_main'] = 'Statistics';

// SMF Project tools admin
$txt['manage_projects'] = 'Projects';
$txt['modify_projects'] = 'Modify Projects';
$txt['new_project'] = 'New Project';

$txt['manage_versions'] = 'Versions';
$txt['modify_versions'] = 'Modify Versions';

$txt['manage_project_category'] = 'Categories';
$txt['modify_project_category'] = 'Modify Categories';

$txt['manage_project_permissions'] = 'Permissions';
$txt['modify_project_profiles'] = 'Modify Profiles';
$txt['new_project_profile'] = 'New Profile';
$txt['project_permissions'] = 'Permissions';

$txt['project_settings'] = 'Settings';
$txt['project_settings_main'] = 'Main';

$txt['projectEnabled'] = 'Enable Project Tools';
$txt['projectAttachments'] = 'Enable Attachments';
$txt['issuesPerPage'] = 'Issues Per Page';
$txt['commentsPerPage'] = 'Comments Per Page';

// Permission Names
$txt['permissiongroup_project'] = 'Project Tools';
$txt['permissionname_project_access'] = 'Access Project Tools';
$txt['permissionname_project_profile'] = 'View Project Tools Profile';
$txt['permissionname_project_profile_own'] = 'Own';
$txt['permissionname_project_profile_any'] = 'Any';
$txt['permissionname_project_admin'] = 'Administrate Project Tools';

// Simple permission gropus
$txt['permissiongroup_simple_project'] = 'Use Project Tools';

// Simple permission names
$txt['permissionname_simple_project_profile_own'] = 'View their own Project Tools profile';
$txt['permissionname_simple_project_profile_any'] = 'View any Project Tools profile';

// Errors
$txt['cannot_project_access'] = 'You are not allowed to access Project Tools.';
$txt['cannot_project_view'] = 'You are not allowed to view this project.';
$txt['cannot_project_report'] = 'You are not allowed to report issues of this project.';
$txt['cannot_project_admin'] = 'You are not allowed to administrate.';
$txt['cannot_project_issue_view'] = 'You are not allowed to view issues of this project.';
$txt['cannot_project_issue_report'] = 'You are not allowed to report issues of this project.';
$txt['cannot_project_edit_comment_own'] = 'You are not allowed to edit comments.';]]></add>
		</operation>
	</file>

</modification>