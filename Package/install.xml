<?xml version="1.0"?>
<?xml-stylesheet href="modification.xsl" type="text/xsl"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

	ATTENTION: If you are trying to install this manually, you should try
	the package manager.  If it will not work for you, please take a look
	at the following for information on this format:
		http://mods.simplemachines.org/docs/manual-install.php

================================================================================

	Modification files can be used to modify files so that they do what
	your package needs them to do to work properly.

 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<!-- This information needs to be the same as that in the package-info.xml. -->
	<id>Niko:SMFProject</id>
	<version>{version}</version>

	<!-- Board directory -->
	<file name="$boarddir/index.php">
		<operation>
			<search position="before"><![CDATA[		'im' => array('PersonalMessage.php', 'MessageMain'),]]></search>
			<add><![CDATA[
		'projects' => array('Project.php', 'Projects'),]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[	elseif (empty($_REQUEST['action']))]]></search>
			<add><![CDATA[	elseif (empty($_REQUEST['action']) && (isset($_REQUEST['project']) || isset($_REQUEST['issue'])))
	{
		require_once($sourcedir . '/Project.php');
		return 'Projects';
	}]]></add>
		</operation>
	</file>

	<!-- Source files -->
	<file name="$sourcedir/Admin.php">
		<operation>
			<search position="after"><![CDATA[		'layout' => array(
			'title' => $txt['layout_controls'],]]></search>
			<add><![CDATA[		'project' => array(
			'title' => $txt['project_tools'],
			'permission' => array('project_admin'),
			'areas' => array(
				'manageprojects' => array(
					'label' => $txt['manage_projects'],
					'file' => 'ManageProjects.php',
					'function' => 'ManageProjects',
					'permission' => array('project_admin'),
					'subsections' => array(
						'main' => array($txt['list_projects']),
						'newproject' => array($txt['new_project']),
					),
				),
				'projectsettings' => array(
					'label' => $txt['project_settings'],
					'file' => 'ProjectAdmin.php',
					'function' => 'ProjectsAdmin',
					'permission' => array('project_admin'),
					'subsections' => array(
						'main' => array($txt['project_settings_main']),
					),
				),
			),
		),]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Display.php">
		<operation>
			<search position="after"><![CDATA[
	// This is just a regular attachment...
	else]]></search>
			<add><![CDATA[
	elseif (isset($_REQUEST['issue']))
	{
		global $project;
		require_once($sourcedir . '/Project.php');
		loadProjectTools('smf');

		if (strpos($_REQUEST['issue'], '.') !== false)
			list ($_REQUEST['issue'], $_REQUEST['start']) = explode('.', $_REQUEST['issue'], 2);

		$request = $smcFunc['db_query']('', '
			SELECT id_project
			FROM {db_prefix}issues
			WHERE id_issue = {int:issue}',
			array(
				'issue' => (int) $_REQUEST['issue']
			)
		);

		list ($_REQUEST['project']) = $smcFunc['db_fetch_row']($request);

		loadProjectPermission($_REQUEST['project']);

		if (!($context['project'] = loadProject((int) $_REQUEST['project'])))
			fatal_lang_error('project_not_found', false);

		$project = $context['project']['id'];

		// Make sure this attachment is on this board.
		$request = $smcFunc['db_query']('', '
			SELECT a.id_folder, a.filename, a.fileext, a.id_attach, a.attachment_type, a.mime_type, a.approved
			FROM {db_prefix}attachments AS a
				INNER JOIN {db_prefix}issues AS i ON (i.id_issue = a.id_issue AND {query_see_issue})
			WHERE a.id_attach = {int:attach}
			LIMIT 1',
			array(
				'attach' => $_REQUEST['attach'],
			)
		);
	}]]></add>
		</operation>
	</file>

	<file name="$sourcedir/ManagePermissions.php">
		<operation>
			<search position="before"><![CDATA[			'profile_remote_avatar' => array(false, 'profile', 'use_avatar'),]]></search>

			<add><![CDATA[
			'project_access' => array(false, 'project', 'project'),
			'project_admin' => array(false, 'project', 'administrate'),
			'issue_view' => array(false, 'project', 'project'),]]></add>
		</operation>
	</file>

	<file name="$sourcedir/ManageSettings.php">
		<operation>
			<search position="after"><![CDATA[
		// pm = post moderation.]]></search>
			<add><![CDATA[		// pj = project tools
		'pj' => array(
			'settings' => array(
				'projectEnabled' => 1,
			),
		),]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Who.php">
		<operation>
			<search position="after"><![CDATA[		'mods' => array(]]></search>
			<add><![CDATA[
				'SMF Project Tools &copy; 2007-2008<br /><span class="smalltext">Uses <a href="http://www.famfamfam.com/lab/icons/silk/" rel="nofollow">FamFamFam Silk</a> icons licensed under Creative Commons Attribution 2.5 License</span>',]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Subs.php">
		<operation>
			<search position="before"><![CDATA[	$context['allow_calendar'] = allowedTo('calendar_view') && !empty($modSettings['cal_enabled']);]]></search>
			<add><![CDATA[	$context['allow_project'] = !empty($modSettings['projectEnabled']) && allowedTo('project_access');]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[			'search' => array(]]></search>
			<add><![CDATA[			'projects' => array(
				'title' => $txt['projects'],
				'href' => $scripturl . '?action=projects',
				'show' => $context['allow_project'],
				'sub_buttons' => array(),
			),]]></add>
		</operation>

		<operation>
			<search position="before"><![CDATA[	if (isset($context['menu_buttons'][$context['current_action']]))
		$current_action = $context['current_action'];]]></search>
			<add><![CDATA[	elseif (empty($_REQUEST['action']) && isset($_REQUEST['project']))
		$current_action = 'projects';]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[|action=profile;u=\d+)'),]]></search>
			<add><![CDATA[|(action=projects)?(sa=viewIssue;)?(;)?issue=(\d+)(\.com(\d+))?(#com(\d+))?]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Subs-Db-mysql.php">
		<operation>
			<search position="after"><![CDATA[
	if (!isset($matches[2]))]]></search>
			<add><![CDATA[
	if ($matches[1] === 'query_see_project')
		return $user_info['query_see_project'];
	elseif ($matches[1] === 'query_see_version')
		return $user_info['query_see_version'];
	elseif ($matches[1] === 'query_see_issue')
		return $user_info['query_see_issue'];
]]></add>
		</operation>
	</file>

	<!-- Languages -->
	<file name="$languagedir/Modifications.english.php">
		<operation>
			<search position="end" />
			<add><![CDATA[// SMF Project tools
$txt['project_tools'] = 'Project Tools';
$txt['issue_tracker'] = 'Issue Tracker';
$txt['issues'] = 'Issues';
$txt['project'] = 'Project';
$txt['projects'] = 'Projects';
$txt['core_settings_item_pj'] = 'Project Tools';
$txt['core_settings_item_pj_desc'] = 'Enables/Disables Project Tools addon';

// SMF Project tools admin
$txt['manage_projects'] = 'Projects';
$txt['list_projects'] = 'Modify Projects';
$txt['new_project'] = 'New Project';
$txt['list_projects'] = 'Project List';
$txt['project_settings'] = 'Settings';
$txt['project_settings_main'] = 'Main';

$txt['projectEnabled'] = 'Enable Project Tools';
$txt['projectAttachements'] = 'Enable Attachements';
$txt['issuesPerPage'] = 'Issues Per Page';

// Permission Names
$txt['permissiongroup_project'] = 'Project Tools';
$txt['permissionname_project_access'] = 'Access Project Tools';
$txt['permissionname_project_admin'] = 'Administrate Project Tools';

// Simple permission gropus
$txt['permissiongroup_simple_project'] = 'Use Project Tools';

// Errors
$txt['cannot_project_access'] = 'You are not allowed to access Project Tools.';
$txt['cannot_project_view'] = 'You are not allowed to view this project.';
$txt['cannot_project_report'] = 'You are not allowed to report issues of this project.';
$txt['cannot_project_admin'] = 'You are not allowed to administrate.';

$txt['cannot_issue_access'] = 'You don\'t have permission to view our Issue Tracker';
$txt['cannot_issue_report'] = 'You don\'t have permission to report issues on our Issue Tracker';]]></add>
		</operation>
	</file>

</modification>